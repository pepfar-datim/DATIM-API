---
title: "Introduction to OAuthentication in datimutils"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to OAuthentication in datimutils}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
This documentation is intended to explain the OAuthentication functions found in datimutils, primarily focusing on the script oAuthLogin.R and its adjacent shiny applications.

## Section 1 - Purpose
The purpose of the functions found in oAuthLogin.R is to make a developer's life easier by giving them a way to seamlessly secure their Shiny apps via OAuth2. By leveraging the security of DHIS2, developers can focus on coding as opposed to worrying about the security of their end product. Shiny developer's have seen an abundance of authentication options rolled out over the years, but these functions will be tailored specifically to DATIM. 

## Section 2 - Base Script 
The script, oAuthLogin.R, is the basis of the OAuthentication shiny app examples found in datimutils. It utilizes the 'httr' and 'xml2' r packages. The 'httr' package specifically contains several OAuth/api functions that are built upon here. There are three functions derived from this script that culminate in an R6 session variable that enables the user to access the DATIM api. The functions are d2session, getOAuthToken, and loginToDATIMOAuth which will all be explained in the next section. 

## Section 3 - Functions
1) The below functions culminate in a d2session, which is an R6 object that is created based upon the users unique credentials and permissions in DATIM. This object is ultimately saved in the users session environment until exiting or time out. 

2) This function retrieves the authentication token from DATIM. 
      * getOAuthToken(redirect_uri,app,api,scope)

3) This function is what brings all three together and allows the user to log in
      * loginToDATIMOAuth (base_url = NULL,
                         token = NULL, 
                         redirect_uri= NULL,
                         app= NULL,
                         api= NULL,
                         scope= NULL,
                         d2_session_name = "d2_default_session",
                         d2_session_envir = parent.frame())



### Shiny Specific Information
By adding the 'shiny' package into the mix it allows the application to access the web url before and after the user is authorized. This is imperative to access the authentication code, which tells the server to grant the user an access token, seamlessly without the shiny app ever handling a password. In the templates section of this package you will find two example apps that show how to harness the OAuth functionality. Both templates are easily adapted solutions to any current shiny application with a few minor tweaks to the code. Specifically the developer will need to define their specific OAuth Clients details such as redirect uri, endpoints, and application info which can be found in DATIM. 

* oAuthDirect/app.R 
This shiny app is the more basic of the two. Whenever the user navigates to your app, they will instantly be redirected to DATIM to authenticate. Simply develop your application as you normally would, but start from within this template. The only key modification that will have to be made is renaming your original ui to uiBase. An example of this integration can be found in the templates folder.

* oAuthLoginScreen/app.R
This shiny app is slightly more advance in that it gives the end user the option of how they log in. Whenever the user navigates to your app they will arrive at a landing page with the option to enter their credentials, or click 'Authenticate with DATIM'. This app template does include more logic and thus is larger, but is still easily adaptable to any code.

The developer could also wait until post development to integrate either of these templates in order to speed up the process by avoiding authenticating every time the app is launched during development.

### Example
Two example shiny apps can be found in the templates folder, note these require a DHIS2 client be setup. 

If the developer wishes to work from the CL or IDE the below code snippet should suffice in helping get started. Note you will need to provide your own DATIM oauth app details. These can be found in your DHIS2 instance under web settings,for example https://play.dhis2.org/2.36.8/dhis-web-settings/index.html#/oauth2. The developer will need to login, then copy the code from the address bar to enter in their IDE when prompted.
```{r example, eval=FALSE, include=TRUE}
 {
### Define variables

 redirect_uri <- "http://127.0.0.1:8100/"

### Copy information directly from the dhis2.org web settings
 app <- oauth_app("OAuth2 Demo Client", # dhis2 = Name
                  key = "demo",         # dhis2 = Client ID
                  secret =
                "76fd0224e-923c-fc67-151a-7619de5c5f7", #dhis2 = Client Secret
                  redirect_uri = redirect_uri
 )

### Endpoint details
 api <- oauth_endpoint(base_url = "https://play.dhis2.org/2.36.4/uaa/oauth",
                       # Documentation says to leave this NULL for OAuth2
                       request=NULL,
                       authorize = "authorize",
                       access="token"
 )

### Scope of what is to be returned
 scope <- "ALL"
### Set options
 options(httr_oob_default=TRUE)

### Use function created above
 loginToDATIMOAuth(base_url = "play.dhis2.org/2.36.4/",app=app, api = api,
 redirect_uri=redirect_uri,scope = scope)

### Try to query the API using the D2Session created above.
 data <- getMetadata(
   end_point = "organisationUnits",
   "organisationUnitGroups.name:eq:District",
   fields = "id,name,level"
 )
 head(data)
 }
```
